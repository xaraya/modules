<xar:comment> License: GPL http://www.gnu.org/copyleft/gpl.html </xar:comment>
<xar:style scope="module" module="base" file="navtabs" />
<div class="xar-mod-head"><span class="xar-mod-title"><xar:mlstring>xarCacheManager Administration</xar:mlstring></span></div>
<div class="xar-mod-body">
  <xar:template type="module" file="admin-menu" module="xarcachemanager" />
  <h2><xar:mlstring>Cache Statistics</xar:mlstring></h2>
    <div>
        <dl class="xar-tabs">
            <dt class="help">
                <xar:mlstring>
                    Select
                </xar:mlstring>
                : 
            </dt>
            <xar:if condition="empty($tab) or $tab eq 'overview'">
                <dd class="active">
                    <a href="#xarModURL('xarcachemanager', 'admin', 'stats', array('tab' => 'overview'))#">
                        <xar:mlstring>Stats Summary</xar:mlstring>
                    </a>
                </dd>    
            <xar:else />
                <dd>
                    <a href="#xarModURL('xarcachemanager', 'admin', 'stats', array('tab' => 'overview'))#">    
                        <xar:mlstring>Overview</xar:mlstring>
                    </a>
                </dd>    
            </xar:if>
            <xar:if condition="$tab eq 'page'">
                <dd class="active">
                    <a href="#xarModURL('xarcachemanager', 'admin', 'stats', array('tab' => 'page'))#">
                        <xar:mlstring>Page</xar:mlstring>
                    </a>
                </dd>    
            <xar:else />
                <dd>
                    <a href="#xarModURL('xarcachemanager', 'admin', 'stats', array('tab' => 'page'))#">    
                        <xar:mlstring>Page</xar:mlstring>
                    </a>
                </dd>    
            </xar:if>
<xar:comment> TODO
            <xar:if condition="$tab eq 'mod'">
                <dd class="active">
                    <a href="#xarModURL('xarcachemanager', 'admin', 'stats', array('tab' => 'mod'))#">
                        <xar:mlstring>Module</xar:mlstring>
                    </a>
                </dd>    
            <xar:else />
                <dd>
                    <a href="#xarModURL('xarcachemanager', 'admin', 'stats', array('tab' => 'mod'))#">    
                        <xar:mlstring>Module</xar:mlstring>
                    </a>
                </dd>    
            </xar:if>
</xar:comment>
            <xar:if condition="$tab eq 'block'">
                <dd class="active">
                    <a href="#xarModURL('xarcachemanager', 'admin', 'stats', array('tab' => 'block'))#">
                        <xar:mlstring>Block</xar:mlstring>
                    </a>
                </dd>    
            <xar:else />
                <dd>
                    <a href="#xarModURL('xarcachemanager', 'admin', 'stats', array('tab' => 'block'))#">    
                        <xar:mlstring>Block</xar:mlstring>
                    </a>
                </dd>    
            </xar:if>
            <xar:if condition="$tab eq 'query'">
                <dd class="active">
                    <a href="#xarModURL('xarcachemanager', 'admin', 'stats', array('tab' => 'query'))#">
                        <xar:mlstring>Query</xar:mlstring>
                    </a>
                </dd>    
            <xar:else />
                <dd>
                    <a href="#xarModURL('xarcachemanager', 'admin', 'stats', array('tab' => 'query'))#">    
                        <xar:mlstring>Query</xar:mlstring>
                    </a>
                </dd>    
            </xar:if>
            <xar:if condition="$tab eq 'autocache'">
                <dd class="active">
                    <a href="#xarModURL('xarcachemanager', 'admin', 'stats', array('tab' => 'autocache'))#">
                        <xar:mlstring>Auto-Cache</xar:mlstring>
                    </a>
                </dd>    
            <xar:else />
                <dd>
                    <a href="#xarModURL('xarcachemanager', 'admin', 'stats', array('tab' => 'autocache'))#">    
                        <xar:mlstring>Auto-Cache</xar:mlstring>
                    </a>
                </dd>    
            </xar:if>
        </dl>
    </div>
    
    
    <div style="border: 1px solid #ccc; text-align: left; width: 100%; border-top: none; padding-left: 5px;">
    <xar:comment> ------------------- Begin Overview Statistics --------------------- </xar:comment>
    <br />
    <xar:if condition="empty($tab) or $tab eq 'overview'">

    <table class="xar-norm">
    <tr>
      <td valign="top">

        <h3><xar:mlstring>Page Cache</xar:mlstring></h3>

        <xar:if condition="!empty($PageCachingEnabled)">
        <table class="xar-norm">
            <tr>
                <th>
                    <xar:mlstring>Storage</xar:mlstring>
                </th>
                <td>
                    <xar:if condition="!empty($settings['PageCacheStorage'])">
                        #$settings['PageCacheStorage']#
                    </xar:if>
                </td>
            </tr>
            <tr>
                <th>
                    <xar:mlstring>Items</xar:mlstring>
                </th>
                <td>
                    <xar:if condition="!empty($pagecache['items'])">
                        #$pagecache['items']#
                    </xar:if>
                </td>
            </tr>
            <tr>
                <th>
                    <xar:mlstring>Size</xar:mlstring>
                </th>
                <td>
                    <xar:if condition="!empty($pagecache['size'])">
                        #$pagecache['size']#
                    </xar:if>
                </td>
            </tr>
            <tr>
                <th>
                    <xar:mlstring>Logfile</xar:mlstring>
                </th>
                <td>
                    <xar:if condition="!empty($settings['PageLogFile'])">
                        #$settings['PageLogFile']#
                    </xar:if>
                </td>
            </tr>
            <xar:if condition="!empty($settings['PageLogFile'])">
                <tr>
                    <th>
                        <xar:mlstring>Ratio</xar:mlstring>
                    </th>
                    <td>
                        <strong>#$pagelog['ratio']#%</strong>
                    </td>
                </tr>
                <tr>
                    <th>
                        <xar:mlstring>Lines</xar:mlstring>
                    </th>
                    <td>
                        #$pagelog['lines']#
                    </td>
                </tr>
                <tr>
                    <th>
                        <xar:mlstring>Logsize</xar:mlstring>
                    </th>
                    <td>
                        #$pagelog['size']#
                    </td>
                </tr>
            </xar:if>
        </table>
        <xar:else/>
            <xar:mlstring>Disabled</xar:mlstring>
        </xar:if>

<!-- TODO
      </td>
      <td valign="top">

        <h3><xar:mlstring>Module Cache</xar:mlstring></h3>

        <xar:if condition="!empty($ModCachingEnabled)">
        <table class="xar-norm">
            <tr>
                <th>
                    <xar:mlstring>Storage</xar:mlstring>
                </th>
                <td>
                    <xar:if condition="!empty($settings['ModCacheStorage'])">
                        #$settings['ModCacheStorage']#
                    </xar:if>
                </td>
            </tr>
            <tr>
                <th>
                    <xar:mlstring>Items</xar:mlstring>
                </th>
                <td>
                    <xar:if condition="!empty($modcache['items'])">
                        #$modcache['items']#
                    </xar:if>
                </td>
            </tr>
            <tr>
                <th>
                    <xar:mlstring>Size</xar:mlstring>
                </th>
                <td>
                    <xar:if condition="!empty($modcache['size'])">
                        #$modcache['size']#
                    </xar:if>
                </td>
            </tr>
            <tr>
                <th>
                    <xar:mlstring>Logfile</xar:mlstring>
                </th>
                <td>
                    <xar:if condition="!empty($settings['ModLogFile'])">
                        #$settings['ModLogFile']#
                    </xar:if>
                </td>
            </tr>
            <xar:if condition="!empty($settings['ModLogFile'])">
                <tr>
                    <th>
                        <xar:mlstring>Ratio</xar:mlstring>
                    </th>
                    <td>
                        <strong>#$modlog['ratio']#%</strong>
                    </td>
                </tr>
                <tr>
                    <th>
                        <xar:mlstring>Lines</xar:mlstring>
                    </th>
                    <td>
                        #$modlog['lines']#
                    </td>
                </tr>
                <tr>
                    <th>
                        <xar:mlstring>Logsize</xar:mlstring>
                    </th>
                    <td>
                        #$modlog['size']#
                    </td>
                </tr>
            </xar:if>
        </table>
        <xar:else/>
            <xar:mlstring>Disabled</xar:mlstring>
        </xar:if>
-->
      </td>
      <td valign="top">

        <h3><xar:mlstring>Block Cache</xar:mlstring></h3>

        <xar:if condition="!empty($BlockCachingEnabled)">
        <table class="xar-norm">
            <tr>
                <th>
                    <xar:mlstring>Storage</xar:mlstring>
                </th>
                <td>
                    <xar:if condition="!empty($settings['BlockCacheStorage'])">
                        #$settings['BlockCacheStorage']#
                    </xar:if>
                </td>
            </tr>
            <tr>
                <th>
                    <xar:mlstring>Items</xar:mlstring>
                </th>
                <td>
                    <xar:if condition="!empty($blockcache['items'])">
                        #$blockcache['items']#
                    </xar:if>
                </td>
            </tr>
            <tr>
                <th>
                    <xar:mlstring>Size</xar:mlstring>
                </th>
                <td>
                    <xar:if condition="!empty($blockcache['size'])">
                        #$blockcache['size']#
                    </xar:if>
                </td>
            </tr>
            <tr>
                <th>
                    <xar:mlstring>Logfile</xar:mlstring>
                </th>
                <td>
                    <xar:if condition="!empty($settings['BlockLogFile'])">
                        #$settings['BlockLogFile']#
                    </xar:if>
                </td>
            </tr>
            <xar:if condition="!empty($settings['BlockLogFile'])">
                <tr>
                    <th>
                        <xar:mlstring>Ratio</xar:mlstring>
                    </th>
                    <td>
                        <strong>#$blocklog['ratio']#%</strong>
                    </td>
                </tr>
                <tr>
                    <th>
                        <xar:mlstring>Lines</xar:mlstring>
                    </th>
                    <td>
                        #$blocklog['lines']#
                    </td>
                </tr>
                <tr>
                    <th>
                        <xar:mlstring>Logsize</xar:mlstring>
                    </th>
                    <td>
                        #$blocklog['size']#
                    </td>
                </tr>
            </xar:if>
        </table>
        <xar:else/>
            <xar:mlstring>Disabled</xar:mlstring>
        </xar:if>

      </td>
    </tr>
    <tr>
      <td valign="top">

        <h3><xar:mlstring>Query Cache</xar:mlstring></h3>

        <xar:if condition="!empty($QueryCachingEnabled)">
        <table class="xar-norm">
            <tr>
                <th>
                    <xar:mlstring>Storage</xar:mlstring>
                </th>
                <td>
                    <xar:if condition="!empty($settings['QueryCacheStorage'])">
                        #$settings['QueryCacheStorage']#
                    </xar:if>
                </td>
            </tr>
            <tr>
                <th>
                    <xar:mlstring>Items</xar:mlstring>
                </th>
                <td>
                    <xar:if condition="!empty($querycache['items'])">
                        #$querycache['items']#
                    </xar:if>
                </td>
            </tr>
            <tr>
                <th>
                    <xar:mlstring>Size</xar:mlstring>
                </th>
                <td>
                    <xar:if condition="!empty($querycache['size'])">
                        #$querycache['size']#
                    </xar:if>
                </td>
            </tr>
        </table>
        <xar:else/>
            <!-- xar:mlstring>Disabled</xar:mlstring -->
        </xar:if>

      </td>
      <td valign="top">

        <h3><xar:mlstring>Auto-Cache</xar:mlstring></h3>

        <xar:if condition="!empty($AutoCachingEnabled)">
        <table class="xar-norm">
            <tr>
                <th>
                    <xar:mlstring>Logfile</xar:mlstring>
                </th>
                <td>
                    <xar:if condition="!empty($settings['AutoCacheLogFile'])">
                        #$settings['AutoCacheLogFile']#
                    </xar:if>
                </td>
            </tr>
            <xar:if condition="!empty($settings['AutoCacheLogFile'])">
                <tr>
                    <th>
                        <xar:mlstring>Ratio</xar:mlstring>
                    </th>
                    <td>
                        <strong>#$autocachelog['ratio']#%</strong>
                    </td>
                </tr>
                <tr>
                    <th>
                        <xar:mlstring>Lines</xar:mlstring>
                    </th>
                    <td>
                        #$autocachelog['lines']#
                    </td>
                </tr>
                <tr>
                    <th>
                        <xar:mlstring>Logsize</xar:mlstring>
                    </th>
                    <td>
                        #$autocachelog['size']#
                    </td>
                </tr>
            </xar:if>
            <tr>
                <th>
                    <xar:mlstring>Statfile</xar:mlstring>
                </th>
                <td>
                    <xar:if condition="!empty($settings['AutoCacheStatFile'])">
                        #$settings['AutoCacheStatFile']#
                    </xar:if>
                </td>
            </tr>
            <xar:if condition="!empty($settings['AutoCacheStatFile'])">
                <tr>
                    <th>
                        <xar:mlstring>Ratio</xar:mlstring>
                    </th>
                    <td>
                        <strong>#$autocachestat['ratio']#%</strong>
                    </td>
                </tr>
                <tr>
                    <th>
                        <xar:mlstring>Lines</xar:mlstring>
                    </th>
                    <td>
                        #$autocachestat['lines']#
                    </td>
                </tr>
                <tr>
                    <th>
                        <xar:mlstring>Statsize</xar:mlstring>
                    </th>
                    <td>
                        #$autocachestat['size']#
                    </td>
                </tr>
            </xar:if>
        </table>
        <xar:else/>
            <xar:mlstring>Disabled</xar:mlstring>
        </xar:if>

      </td>
    </tr>
    </table>
    <form method="post" action="#xarModURL('xarcachemanager', 'admin', 'stats')#">
      <input type="hidden" name="tab" id="tab" value="overview" />
      <xar:mlstring>Items per page</xar:mlstring>
      <input type="text" name="itemsperpage" id="itemsperpage" value="#$itemsperpage#" size="4" />
      <input type="submit" name="change" id="change" value="#xarML('Change')#" />
    </form>

    <xar:comment> ----------------- Begin Page / Module / Block Statistics ------------------- </xar:comment>
    <xar:elseif condition="$tab eq 'page' or $tab eq 'mod' or $tab eq 'block'" />

        <xar:if condition="$tab eq 'page'">
          <h3><xar:mlstring>Page Cache Statistics</xar:mlstring></h3>
        <xar:elseif condition="$tab eq 'mod'"/>
          <h3><xar:mlstring>Module Cache Statistics</xar:mlstring></h3>
        <xar:elseif condition="$tab eq 'block'"/>
          <h3><xar:mlstring>Block Cache Statistics</xar:mlstring></h3>
        </xar:if>

        <xar:if condition="empty($withlog)">
            <a href="#xarModURL('xarcachemanager','admin','stats',array('tab' => $tab, 'withlog' => 1))#"><xar:mlstring>Analyze Logfile</xar:mlstring></a>
        <xar:else/>
            <form method="post" action="#xarModURL('xarcachemanager', 'admin', 'stats')#">
              <strong><xar:ml><xar:mlstring>Overall Cache Hit Ratio : #(1)%</xar:mlstring><xar:mlvar>#$totals['ratio']#</xar:mlvar></xar:ml></strong>
              <input type="hidden" name="tab" id="tab" value="#$tab#" />
              <input type="hidden" name="authid" id="authid" value="#xarSecGenAuthKey()#" />
              <input type="submit" name="reset" value="#xarML('Reset')#" />
            </form>
        </xar:if>

        <table class="xar-norm">
        <xar:if condition="!empty($withlog)">
        <tr>
          <th><a href="#xarModURL('xarcachemanager','admin','stats',array('tab' => $tab,'withlog' => $withlog,'sort' => 'ratio'))#"><xar:mlstring>Ratio</xar:mlstring></a></th>
          <th><a href="#xarModURL('xarcachemanager','admin','stats',array('tab' => $tab,'withlog' => $withlog,'sort' => 'hit'))#"><xar:mlstring>Hit</xar:mlstring></a></th>
          <th><a href="#xarModURL('xarcachemanager','admin','stats',array('tab' => $tab,'withlog' => $withlog,'sort' => 'miss'))#"><xar:mlstring>Miss</xar:mlstring></a></th>
          <th><a href="#xarModURL('xarcachemanager','admin','stats',array('tab' => $tab,'withlog' => $withlog,'sort' => 'total'))#"><xar:mlstring>Total</xar:mlstring></a></th>
          <th><a href="#xarModURL('xarcachemanager','admin','stats',array('tab' => $tab,'withlog' => $withlog,'sort' => 'pages'))#"><xar:mlstring>Pages</xar:mlstring></a></th>
          <th><a href="#xarModURL('xarcachemanager','admin','stats',array('tab' => $tab,'withlog' => $withlog,'sort' => 'first'))#"><xar:mlstring>First Seen</xar:mlstring></a></th>
          <th><a href="#xarModURL('xarcachemanager','admin','stats',array('tab' => $tab,'withlog' => $withlog,'sort' => 'last'))#"><xar:mlstring>Last Seen</xar:mlstring></a></th>
        </tr>
        </xar:if>
        <tr>
          <th><a href="#xarModURL('xarcachemanager','admin','stats',array('tab' => $tab,'withlog' => $withlog,'sort' => 'size'))#"><xar:mlstring>Size</xar:mlstring></a></th>
          <th colspan="4"><a href="#xarModURL('xarcachemanager','admin','stats',array('tab' => $tab,'withlog' => $withlog,'sort' => 'key'))#"><xar:mlstring>Key</xar:mlstring></a></th>
          <th><a href="#xarModURL('xarcachemanager','admin','stats',array('tab' => $tab,'withlog' => $withlog,'sort' => 'code'))#"><xar:mlstring>Code</xar:mlstring></a></th>
          <th><a href="#xarModURL('xarcachemanager','admin','stats',array('tab' => $tab,'withlog' => $withlog,'sort' => 'time'))#"><xar:mlstring>Last Modified</xar:mlstring></a></th>
        </tr>
        <xar:foreach in="$items" key="$id" value="$item">
        <xar:if condition="!empty($withlog)">
        <tr class="xar-alt">
          <td>#$item['ratio']#%</td>
          <td>#$item['hit']#</td>
          <td>#$item['miss']#</td>
          <td>#$item['total']#</td>
          <td>#$item['pages']#</td>
          <td><xar:if condition="!empty($item['first'])">#xarLocaleFormatDate('%a, %d %B %Y %H:%M:%S %Z',$item['first'])#</xar:if></td>
          <td><xar:if condition="!empty($item['last'])">#xarLocaleFormatDate('%a, %d %B %Y %H:%M:%S %Z',$item['last'])#</xar:if></td>
        </tr>
        </xar:if>
        <tr>
          <td>#$item['size']#</td>
          <td colspan="4">#$item['key']#</td>
          <td>#$item['code']#</td>
          <td><xar:if condition="!empty($item['time'])">#xarLocaleFormatDate('%a, %d %B %Y %H:%M:%S %Z',$item['time'])#</xar:if></td>
        </tr>
        </xar:foreach>
        <xar:if condition="!empty($withlog) and !empty($totals)">
        <tr>
          <th>#$totals['ratio']#%</th>
          <th>#$totals['hit']#</th>
          <th>#$totals['miss']#</th>
          <th>#$totals['total']#</th>
          <th>#$totals['pages']#</th>
          <th>#xarLocaleFormatDate('%a, %d %B %Y %H:%M:%S %Z',$totals['first'])#</th>
          <th>#xarLocaleFormatDate('%a, %d %B %Y %H:%M:%S %Z',$totals['last'])#</th>
        </tr>
        </xar:if>
        <xar:if condition="!empty($pager)">
        <tr>
            <td colspan="7" align="center">#$pager#</td>
        </tr>
        </xar:if>
        </table>

    <xar:comment> ----------------- Begin Query Statistics ------------------- </xar:comment>
    <xar:elseif condition="$tab eq 'query'" />

        <h3><xar:mlstring>Query Cache Statistics</xar:mlstring></h3>
        <xar:mlstring>to be defined</xar:mlstring>

    <xar:comment> ----------------- Begin Auto-Cache Statistics ------------------- </xar:comment>
    <xar:elseif condition="$tab eq 'autocache'" />

        <h3><xar:mlstring>Auto-Cache Statistics</xar:mlstring></h3>
        <xar:if condition="empty($withlog)">
            <a href="#xarModURL('xarcachemanager','admin','stats',array('tab' => $tab, 'withlog' => 1))#"><xar:mlstring>Analyze Logfile</xar:mlstring></a>
        </xar:if>
        <form method="post" action="#xarModURL('xarcachemanager', 'admin', 'stats')#">
          <strong><xar:ml><xar:mlstring>Overall Cache Hit Ratio : #(1)%</xar:mlstring><xar:mlvar>#$totals['ratio']#</xar:mlvar></xar:ml></strong>
          <input type="hidden" name="tab" id="tab" value="autocache" />
          <xar:if condition="!empty($withlog)">
            <input type="hidden" name="withlog" id="withlog" value="1" />
          <xar:else/>
            <input type="hidden" name="withlog" id="withlog" value="0" />
          </xar:if>
          <input type="hidden" name="authid" id="authid" value="#xarSecGenAuthKey()#" />
          <input type="submit" name="reset" value="#xarML('Reset')#" />
          <br/><xar:mlstring>Note: 304 'Not Modified' hits are not logged</xar:mlstring>
        </form>
        <table class="xar-norm">
        <tr>
          <th><a href="#xarModURL('xarcachemanager','admin','stats',array('tab' => 'autocache','sort' => 'ratio'))#"><xar:mlstring>Ratio</xar:mlstring></a></th>
          <th><a href="#xarModURL('xarcachemanager','admin','stats',array('tab' => 'autocache','sort' => 'hit'))#"><xar:mlstring>Hit</xar:mlstring></a></th>
          <th><a href="#xarModURL('xarcachemanager','admin','stats',array('tab' => 'autocache','sort' => 'miss'))#"><xar:mlstring>Miss</xar:mlstring></a></th>
          <th><a href="#xarModURL('xarcachemanager','admin','stats',array('tab' => 'autocache','sort' => 'total'))#"><xar:mlstring>Total</xar:mlstring></a></th>
          <th><a href="#xarModURL('xarcachemanager','admin','stats',array('tab' => 'autocache','sort' => 'first'))#"><xar:mlstring>First Seen</xar:mlstring></a></th>
          <th><a href="#xarModURL('xarcachemanager','admin','stats',array('tab' => 'autocache','sort' => 'last'))#"><xar:mlstring>Last Seen</xar:mlstring></a></th>
        </tr>
        <tr>
          <th colspan="6"><a href="#xarModURL('xarcachemanager','admin','stats',array('tab' => 'autocache','sort' => 'page'))#"><xar:mlstring>Page</xar:mlstring></a></th>
        </tr>
        <xar:foreach in="$items" key="$page" value="$count">
        <tr class="xar-alt">
          <td>#$count['ratio']#%</td>
          <td>#$count['hit']#</td>
          <td>#$count['miss']#</td>
          <td>#$count['total']#</td>
          <td>#xarLocaleFormatDate('%a, %d %B %Y %H:%M:%S %Z',$count['first'])#</td>
          <td>#xarLocaleFormatDate('%a, %d %B %Y %H:%M:%S %Z',$count['last'])#</td>
        </tr>
        <tr>
          <td colspan="6">#$count['page']#</td>
        </tr>
        </xar:foreach>
        <xar:if condition="!empty($totals)">
        <tr>
          <th>#$totals['ratio']#%</th>
          <th>#$totals['hit']#</th>
          <th>#$totals['miss']#</th>
          <th>#$totals['total']#</th>
          <th>#xarLocaleFormatDate('%a, %d %B %Y %H:%M:%S %Z',$totals['first'])#</th>
          <th>#xarLocaleFormatDate('%a, %d %B %Y %H:%M:%S %Z',$totals['last'])#</th>
        </tr>
        </xar:if>
        <xar:if condition="!empty($pager)">
        <tr>
            <td colspan="6" align="center">#$pager#</td>
        </tr>
        </xar:if>
        </table>

    </xar:if>
    </div>

</div>
